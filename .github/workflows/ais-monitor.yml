name: AIS Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes (GitHub's minimum for scheduled workflows)

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Run AIS monitor
        env:
          AIS_EMAIL_PASSWORD: ${{ secrets.AIS_EMAIL_PASSWORD }}
        run: python ais_monitor.py --once
      
      - name: Commit and push results
        run: |
          git config user.name 'AIS Monitor Bot'
          git config user.email 'actions@github.com'
          git add -A out/
          git add ais_monitor.log ais_trails.db || true
          # Always commit and push (even if data identical, forces GitHub Pages refresh)
          if ! git diff --staged --quiet; then
            git commit -m "Update AIS data - $(date -u +"%Y-%m-%d %H:%M UTC")"
          else
            # Touch a timestamp file to force commit
            echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC")" > out/.timestamp
            git add out/.timestamp
            git commit -m "Update AIS data - $(date -u +"%Y-%m-%d %H:%M UTC")"
          fi
          git push

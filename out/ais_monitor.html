<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AIS Monitor - Keri</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; }
    #map { position: absolute; top: 50px; left: 0; right: 0; bottom: 0; }
    
    header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: linear-gradient(135deg, #0066cc, #004499);
      color: white;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    
    header h1 {
      font-size: 18px;
      font-weight: normal;
    }
    
    #status {
      font-size: 12px;
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 3px;
    }
    
    .legend {
      position: absolute;
      bottom: 30px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      font-size: 12px;
      z-index: 999;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin: 4px 0;
    }
    
    .legend-color {
      width: 20px;
      height: 3px;
      margin-right: 8px;
    }
    
    .timestamp-tooltip {
      background: rgba(255, 102, 0, 0.9);
      border: 1px solid #fff;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 3px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .timestamp-tooltip::before {
      border-top-color: rgba(255, 102, 0, 0.9);
    }
    .station-label {
      background: transparent;
      border: none;
      box-shadow: none;
      color: #000;
      font-weight: bold;
      font-size: 12px;
      text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
    }
    
    .station-label::before {
      border: none;
    }
  </style>
</head>
<body>
  <header>
    <h1>AIS Monitor - Gulf of Finland, Keri | DigiTraffic.fi | Copilot+ & GitHub</h1>
    <div id="status">Loading...</div>
  </header>
  
  <div id="map"></div>
  
  <div class="legend">
    <div class="legend-item">
      <div class="legend-color" style="background: #ff0000; height: 6px;"></div>
      <span>Area</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #888888;"></div>
      <span>Trails (3h)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #ff6600; height: 4px;"></div>
      <span>Trail Highlight (click vessel)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #0066ff; border-radius: 50%; width: 10px; height: 10px;"></div>
      <span>Vessels (click to highlight trail)</span>
    </div>
  </div>
  <div class="legend-item">
      <div class="legend-color" style="background: #FFFF00; border-radius: 50%; width: 10px; height: 10px;"></div>
      <span>Fixed Stations</span>
    </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([59.7, 25.0], 10);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'OpenStreetMap'
    }).addTo(map);
    
    let restrictedLayer = L.geoJSON(null, {
      style: {
        color: '#ff0000',
        weight: 3,
        fillColor: '#ff0000',
        fillOpacity: 0.15
      }
    }).addTo(map);
    
    let trailsData = null;
    let highlightedTrail = null;
    let timestampMarkers = L.layerGroup().addTo(map);
    
    let trailsLayer = L.geoJSON(null, {
      style: {
        color: '#888888',
        weight: 2,
        opacity: 0.6
      }
    }).addTo(map);
    
    function highlightTrail(mmsi) {
      // Clear previous highlight - CRITICAL for preventing memory leaks
      if (highlightedTrail) {
        try {
          map.removeLayer(highlightedTrail);
        } catch (e) {
          console.warn('Error removing highlighted trail:', e);
        }
        highlightedTrail = null;
      }
      timestampMarkers.clearLayers();
      
      if (!trailsData || !mmsi) return;
      
      // Find trail for this MMSI
      const trail = trailsData.features.find(f => f.properties.mmsi === mmsi);
      if (!trail) return;
      
      // Highlight trail
      highlightedTrail = L.geoJSON(trail, {
        style: {
          color: '#ff6600',
          weight: 4,
          opacity: 0.9
        }
      }).addTo(map);
      
      // Add timestamp markers every 15 minutes (max 12 markers = 3 hours)
      const coords = trail.geometry.coordinates;
      const startTime = new Date(trail.properties.start);
      const endTime = new Date(trail.properties.end);
      const totalMinutes = (endTime - startTime) / 60000;
      const intervalMinutes = 15;
      
      if (totalMinutes > intervalMinutes && coords.length > 2) {
        const step = Math.max(1, Math.floor(coords.length / (totalMinutes / intervalMinutes)));
        const maxMarkers = 12; // Safety limit: prevent excessive markers
        let markerCount = 0;
        
        for (let i = 0; i < coords.length && markerCount < maxMarkers; i += step) {
          if (i >= coords.length) break;
          
          const [lon, lat] = coords[i];
          const time = new Date(startTime.getTime() + (i / coords.length) * totalMinutes * 60000);
          
          const marker = L.circleMarker([lat, lon], {
            radius: 4,
            fillColor: '#ff6600',
            color: '#fff',
            weight: 1,
            fillOpacity: 0.9
          }).bindTooltip(time.toLocaleTimeString(), { 
            permanent: false,
            direction: 'top',
            className: 'timestamp-tooltip'
          });
          
          timestampMarkers.addLayer(marker);
          markerCount++;
        }
      }
    }
        
    let fixedPointsLayer = L.geoJSON(null, {
      pointToLayer: (feature, latlng) => {
        return L.circleMarker(latlng, {
          radius: 8,
          fillColor: '#FFFF00',
          color: '#000',
          weight: 2,
          opacity: 1,
          fillOpacity: 1
        });
      },
      onEachFeature: (feature, layer) => {
        const p = feature.properties;
        layer.bindTooltip(p.name, {
          permanent: true,
          direction: 'top',
          className: 'station-label',
          offset: [0, -10]
        });
        layer.bindPopup(`
          <div style="min-width: 150px;">
            <h3 style="margin: 0 0 10px 0; color: #FF8800;">${p.name}</h3>
            <p style="font-size: 12px; margin: 0;">Fixed monitoring station</p>
          </div>
        `);
      }
    }).addTo(map);
    
    let vesselsLayer = L.geoJSON(null, {
      pointToLayer: (feature, latlng) => {
        return L.circleMarker(latlng, {
          radius: 6,
          fillColor: '#0066ff',
          color: '#fff',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        });
      },
      onEachFeature: (feature, layer) => {
        const p = feature.properties;
        const mmsi = p.mmsi;
        
        layer.on('click', () => {
          highlightTrail(mmsi);
        });
        
        layer.bindPopup(`
          <div style="min-width: 200px;">
            <h3 style="margin: 0 0 10px 0; color: #0066cc;">${p.name}</h3>
            <table style="width: 100%; font-size: 12px;">
              <tr><td><b>MMSI:</b></td><td>${mmsi}</td></tr>
              <tr><td><b>Speed:</b></td><td>${p.sog} knots</td></tr>
              <tr><td><b>Course:</b></td><td>${p.cog} deg</td></tr>
              <tr><td><b>Heading:</b></td><td>${p.heading} deg</td></tr>
            </table>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
              <a href="https://www.marinetraffic.com/en/ais/details/ships/${mmsi}" target="_blank">MarineTraffic</a> Â· 
              <a href="https://www.vesselfinder.com/?mmsi=${mmsi}" target="_blank">VesselFinder</a>
            </div>
          </div>
        `);
      }
    }).addTo(map);
    
    let lastUpdate = null;
    
    async function loadData() {
      try {
        // Clear highlighted trail and timestamp markers before refresh - CRITICAL for memory management
        if (highlightedTrail) {
          map.removeLayer(highlightedTrail);
          highlightedTrail = null;
        }
        const clearedMarkers = timestampMarkers.getLayers().length;
        timestampMarkers.clearLayers();
        
        if (clearedMarkers > 0) {
          console.log(`Cleared ${clearedMarkers} timestamp markers on refresh`);
        }
        
        const t = Date.now();
        const [restricted, trails, vessels, fixedPoints] = await Promise.all([
          fetch(`restricted.geojson?_=${t}`).then(r => r.json()),
          fetch(`trails.geojson?_=${t}`).then(r => r.json()),
          fetch(`vessels.geojson?_=${t}`).then(r => r.json()),
          fetch(`fixed_points.geojson?_=${t}`).then(r => r.json()).catch(() => ({type: 'FeatureCollection', features: []}))
        ]);
        
        restrictedLayer.clearLayers().addData(restricted);
        trailsData = trails; // Store for highlighting
        trailsLayer.clearLayers().addData(trails);
        vesselsLayer.clearLayers().addData(vessels);
        fixedPointsLayer.clearLayers().addData(fixedPoints);
        
        // Find most recent vessel timestamp to show actual data age
        let newestTimestamp = 0;
        vessels.features.forEach(f => {
          const ts = parseInt(f.properties.timestamp);
          if (ts > newestTimestamp) newestTimestamp = ts;
        });
        
        const dataTime = new Date(newestTimestamp);
        const dataAge = Math.round((Date.now() - newestTimestamp) / 60000); // minutes
        
        document.getElementById('status').textContent = 
          `${vessels.features.length} vessels, ${trails.features.length} trails | Data: ${dataTime.toLocaleTimeString()} (${dataAge}m ago)`;
        
        // Fit bounds on first load
        if (vessels.features.length > 0 && !map._loaded) {
          const bounds = vesselsLayer.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [50, 50], maxZoom: 11 });
          }
          map._loaded = true;
        }
      } catch (e) {
        console.error('Load error:', e);
        document.getElementById('status').textContent = 'Error loading data';
      }
    }
    
    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>




